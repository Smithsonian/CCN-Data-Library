---
title: "Soil Core Data Visualization Report"
author: "Jaxine Wolfe"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
# this sets the working directory to start where the R project is located
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

# load libraries
library(tidyverse)
library(leaflet)
library(DT)
```

## Overview

```{r echo=FALSE, message=FALSE}

# read in database guidance
guidance <- read_csv("docs/ccrcn_database_structure.csv", col_types = cols())

# read in synthesis data
methods <- read_csv("data/CCRCN_synthesis/derivative/CCRCN_methods.csv", col_types = cols()) %>% 
  mutate(excess_pb210_model = ifelse(study_id == "Peck_et_al_2020", "CIC", excess_pb210_model),
         excess_pb210_rate = recode(excess_pb210_rate, 
                                    "mass accumulation" = "cumulative mass",
                                    "accretion" = "depth", 
                                    "mass accumulation and accretion" = "depth"))

cores <- read_csv("data/CCRCN_synthesis/derivative/CCRCN_cores.csv", guess_max=10000, col_types = cols()) %>% 
  mutate(habitat = ifelse(core_id == "MR3U", "marsh", habitat))

ds <- read_csv("data/CCRCN_synthesis/derivative/CCRCN_depthseries.csv", guess_max=50000, col_types = cols()) %>% 
  select(-site_id)

# isolate cores with fraction C and LOI data
cores_to_keep <- ds %>% drop_na(fraction_carbon, fraction_organic_matter) %>% distinct(core_id) %>% pull(core_id)

c_modeled <- c("Chen_and_Twilley_1999", "Jones_et_al_2016", "Liu_2005", "Liu_et_al_2008", "Naidoo_and_Raiman_1982", "Elsey_Quirk_et_al_2011", "He_et_al_2002", "Ren_et_al_2008",
               "McGlathery_et_al_2012", "Naidoo_1980", "Nsombo_et_al_2016", "Sanders_et_al_2012_MER", "Tam_and_Wong_1998", "Ceron-Breton_et_al_2011", "DelVecchia_et_al_2014",
               "Vasconcelos_et_al_2014", "Yando_et_al_2016", "Callaway_et_al_1997")

# merge all...hallelujah
all <- left_join(ds, cores) %>% 
  left_join(methods) %>%
  filter(core_id %in% cores_to_keep) %>% 
  mutate(carbon_measured_or_modeled = ifelse(study_id %in% c_modeled, "modeled", 
                                             carbon_measured_or_modeled)) %>%
  select_if(function(x) {!all(is.na(x))}) %>% 
  select(study_id, site_id, core_id, method_id, year, month, day, latitude, longitude,
         admin_division, habitat, everything())

```

```{r echo=FALSE, fig.width=12, fig.height=12}
# further filtering for unassigned carbon methods to eliminate modeled values

c_measured <- c("Abbott_et_al_2019", "Arriola_and_Cable_2017", "Breithaupt_et_al_2020",
                "Callaway_et_al_2019", "Chambers_et_al_2019", "Danovaro_1996", "Grady_1981", "McTigue_et_al_2020", "Callaway_et_al_2019",
                "Fourqurean_and_Kendrick_unpublished", "Fourqurean_et_al_2010", "Fourqurean_unpublished", "Hill_and_Anisfeld_2015",
                "Kamp-Nielsen_et_al_2002", "Noe_et_al_2013", "Orem_et_al_1999", "Peck_et_al_2020", "Piazza_et_al_2011",
                "Poppe_and_Rybczyk_2018", "Poppe_et_al_2019", "StLaurent_et_al_2020", "Unger_et_al_2016",
                "Doughty_et_al_2016", "Kazungu_1996", "Kristensen_et_al_1992", "Osland_et_al_2012")

all_measured <- all %>% 
  filter(carbon_measured_or_modeled == "measured" | is.na(carbon_measured_or_modeled)) %>%
  mutate(carbon_measured_or_modeled = ifelse(study_id %in% c_measured, 
                                             "measured", "mixed")) %>% 
  drop_na(fraction_carbon, fraction_organic_matter) %>% 
  add_count(study_id) %>% select(n, everything()) %>% 
  filter(n > 20)

all_measured %>% 
  # filter(study_id == "Breithaupt_et_al_2014") %>%
  ggplot(aes(fraction_organic_matter, fraction_carbon, col = carbon_measured_or_modeled)) +
  geom_point(alpha = 0.5, size = 2) +
  theme_bw(base_size = 15) + 
  facet_wrap(~study_id, scales = "free", ncol = 4) +
  theme(legend.position = "bottom")
```

This dataset contains `r length(unique(all_measured$core_id))` soil profiles in the Coastal Carbon Atlas which have both LOI and %C (represented as fraction_carbon) and across all tidal wetland ecosystem types reported. Fraction C represents only measured values (filtering in progress). The field fraction_carbon_type details whether fraction_carbon is total or organic carbon. Please refer to the database guidance for a more detailed breakdown of the metadata.

### Map of coring locations

```{r echo=FALSE, warning=FALSE, message=FALSE}

map_habs <- all_measured %>% distinct(study_id, site_id, core_id, latitude, longitude, habitat)

pal <- colorFactor(palette = "Set2", map_habs$habitat)

map_habs %>% 
  leaflet(width = "100%") %>% 
  addTiles() %>% 
  addCircleMarkers(lng = ~longitude, lat = ~latitude,
                   radius = 3, 
                   color = ~pal(habitat),
                   label = ~study_id) %>% 
  addLegend(pal = pal, values = ~habitat)

```

### Summary of core utility and completeness

High-value cores are those which are confirmed to represent an entire wetland soil profile (C1). It includes cores with dated stratigraphy and enough detailed information so that important derived variables like carbon accumulation rate and vertical accretion rate can be replicated (B1). It also contains cores with precise elevation data, which can be used to fit models that forecast wetland elevation and carbon stock response to sea-level rise (A2 and A1). Note: A core can be included in up to three use categories, depending on the information provided.

```{r echo=FALSE, warning=FALSE, message=FALSE}
# Isolate definitions for quality codes
quality_defs <- guidance %>% 
  select(attribute_name, format_unit_codes) %>% 
  filter(attribute_name %in% c("stocks_qual_code", "dates_qual_code", "elevation_qual_code")) %>% 
  mutate(code_definition = str_split(format_unit_codes, "; ")) %>% 
  unnest(code_definition) %>% 
  separate(code_definition, into = c("quality_code", "code_definition"), sep = " = ") %>% 
  select(quality_code, code_definition) %>% 
  arrange(quality_code)

quality_smry <- all_measured %>% 
  select(study_id, site_id, core_id, stocks_qual_code, dates_qual_code, elevation_qual_code) %>% 
  pivot_longer(cols = c(stocks_qual_code, dates_qual_code, elevation_qual_code), names_to = "use_category",
               values_to = "quality_code") %>% 
  drop_na(quality_code) %>% 
  distinct() %>% 
  count(use_category, quality_code, name = "core_count") %>% 
  left_join(quality_defs) %>% 
  mutate(use_category = recode(use_category,
                               "dates_qual_code" = "Dated stratigraphy",
                               "stocks_qual_code" = "Carbon stock",
                               "elevation_qual_code" = "Elevation")) %>% 
  arrange(quality_code)

knitr::kable(quality_smry)
```

### Relationship between LOI and fraction carbon across all ecosystem types

```{r echo=FALSE, fig.height=8, fig.width=12}
all_measured %>% 
  drop_na(fraction_carbon, fraction_organic_matter) %>%
  ggplot(aes(fraction_organic_matter, fraction_carbon, col = habitat)) +
  geom_point(alpha = 0.5, size = 2) +
  theme_bw(base_size = 15) + 
  facet_wrap(~habitat, scales = "free") +
  theme(legend.position = "none")

```

## Habitat Specific Summaries

### Mangrove

Relationship between fraction carbon and LOI across individual studies. Fraction carbon values may be measured or modeled.
```{r echo=FALSE, fig.width=12, fig.height=12}

all_measured %>% 
  filter(habitat == "mangrove") %>% 
  drop_na(fraction_carbon, fraction_organic_matter) %>%
  ggplot(aes(fraction_organic_matter, fraction_carbon, 
             col = fraction_carbon_type)) +
  geom_point(alpha = 0.5, size = 2) +
  scale_color_brewer(palette = "Dark2", na.value = "grey50") +
  theme_bw(base_size = 15) + 
  facet_wrap(~study_id, scales = "free") +
  theme(legend.position = "bottom")

```

**High-value mangrove cores**

Note: The current version of the CCN database contains no mangrove cores with associated elevation information.

```{r echo=FALSE}

mangrove_smry <- all_measured %>%
  filter(habitat == "mangrove") %>%
  filter(stocks_qual_code == "C1" | !is.na(dates_qual_code) |
           !is.na(elevation_qual_code)) %>% 
  select(study_id, site_id, core_id, stocks_qual_code, dates_qual_code, elevation_qual_code) %>% 
  distinct() %>% select(-elevation_qual_code)

datatable(mangrove_smry,
          options = list(searching = FALSE,
                         paging = FALSE,
                         info = FALSE,
                         scrollY = 300,
                         scrollX = 300,
                         scrollCollapse = TRUE),
          rownames = FALSE)

```

### Tidal Marsh

Relationship between fraction carbon and LOI across individual studies. Fraction carbon values may be measured or modeled.
```{r echo=FALSE, fig.width=12, fig.height=12}
library(RColorBrewer)

all_measured %>% 
  filter(habitat == "marsh") %>% 
  drop_na(fraction_carbon, fraction_organic_matter) %>%
  ggplot(aes(fraction_organic_matter, fraction_carbon, 
             col = fraction_carbon_type)) +
  geom_point(alpha = 0.5, size = 2) +
  scale_color_brewer(palette = "Dark2", na.value = "grey50") +
  theme_bw(base_size = 15) + 
  facet_wrap(~study_id, scales = "free") +
  theme(legend.position = "bottom")

```

**High-value marsh cores**
```{r echo=FALSE}

marsh_smry <- all_measured %>%
  filter(habitat == "marsh") %>%
  filter(stocks_qual_code == "C1" | !is.na(dates_qual_code) |
           !is.na(elevation_qual_code)) %>% 
  select(study_id, site_id, core_id, stocks_qual_code, dates_qual_code, elevation_qual_code) %>% 
  distinct()

datatable(marsh_smry,
          options = list(searching = FALSE,
                         paging = FALSE,
                         info = FALSE,
                         scrollY = 300,
                         scrollX = 300,
                         scrollCollapse = TRUE),
          rownames = FALSE)
```

```{r echo=FALSE}

# create bibliography
bib <- read_csv("data/CCRCN_synthesis/derivative/CCRCN_study_citations.csv", col_types = cols()) %>% 
  filter(study_id %in% unique(all_measured$study_id))

# write data and bib
write_csv(all_measured, "docs/cores_for_brian/ccrcn_core_data.csv")
write_csv(bib, "docs/cores_for_brian/ccrcn_core_data_bibliography.csv")
```

